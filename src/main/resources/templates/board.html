<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
  <!-- <title th:text="${isAdmin ? 'PETOPIA - ê´€ë¦¬ì ë¡œê·¸ì¸' : 'PETOPIA'}">ììœ ê²Œì‹œíŒ</title> -->
  <title th:text="${session.member != null && session.member.role.name() == 'ADMIN'} ? 'PETOPIA - ê´€ë¦¬ì ë¡œê·¸ì¸' : 'PETOPIA ììœ ê²Œì‹œíŒ'">PETOPIA ììœ ê²Œì‹œíŒ</title>
  <link rel="stylesheet" href="/css/header.css">
  <link rel="stylesheet" href="/css/footer.css">
  <link rel="stylesheet" href="/css/board.css">
  <style>
    /* ìƒˆë¡œê³ ì¹¨ ì¸ë””ì¼€ì´í„° ìŠ¤íƒ€ì¼ */
    .refresh-indicator {
      position: fixed;
      top: 70px;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
      width: 100%;
      padding: 15px;
      background-color: rgba(255, 255, 255, 0.95);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      display: none;
    }

    .refresh-spinner {
      width: 30px;
      height: 30px;
      margin: 0 auto;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #2C74D2;
      border-radius: 50%;
      transition: transform 0.3s ease-in-out;
    }

    .refresh-text {
      margin-top: 8px;
      color: #2C74D2;
      font-size: 14px;
      font-weight: bold;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .spinning {
      animation: spin 1s linear infinite;
    }

    .posts-container {
      transition: transform 0.3s ease-out;
      padding-top: 10px;
    }

    .board-stats {
        margin-left: auto;
        display: flex;
        gap: 10px;
        color: #666;
    }

    .views, .likes {
        display: flex;
        align-items: center;
        gap: 3px;
    }
  </style>
</head>
<body>

  <!-- header -->
  <div th:replace="~{common/header :: header}"></div>
  <!-- /header -->
  <div class="main-content">
    <!-- ìƒˆë¡œê³ ì¹¨ ì¸ë””ì¼€ì´í„° ì¶”ê°€ -->
    <div class="refresh-indicator">
      <div class="refresh-spinner"></div>
      <div class="refresh-text">ë‹¹ê²¨ì„œ ìƒˆë¡œê³ ì¹¨</div>
    </div>
    <button id="top-btn" onclick="scrollToTop()">â†‘</button>
    
    <div class="boardMenu-container">
      <div class="boardMenu">
        <div onclick="filterPosts('ì „ì²´')" class="active">
          <img src="/images/home-4-home-house-roof-shelter1.svg" alt="ì „ì²´">
          <div class="div3">ì „ì²´</div>
        </div>
        <div onclick="filterPosts('ê³µì§€ì‚¬í•­')">
          <img src="/images/volume.svg" alt="ê³µì§€">
          <div class="div5">ê³µì§€</div>
        </div>
        <div onclick="filterPosts('ì§ˆë¬¸')">
          <img src="/images/union0.svg" alt="ì§ˆë¬¸">
          <div class="div6">ì§ˆë¬¸</div>
        </div>
        <div onclick="filterPosts('ììœ ')">
          <img src="/images/chat-bubble-square-write-messages-message-bubble-chat-square-write-review-pen-pencil-compose1.svg" alt="ììœ ">
          <div class="div7">ììœ </div>
        </div>
        <div onclick="filterPosts('ë‚˜ëˆ”')">
          <img src="/images/coin-share-payment-cash-money-finance-receive-give-coin-hand1.svg" alt="ë‚˜ëˆ”">
          <div class="div8">ë‚˜ëˆ”</div>
        </div>
        <div onclick="filterPosts('ì´ë²¤íŠ¸')">
          <img src="/images/gift-reward-box-social-present-gift-media-rating-bow1.svg" alt="ì´ë²¤íŠ¸">
          <div class="div10">ì´ë²¤íŠ¸</div>
        </div>
      </div>
    </div>
    
    <div class="posts-container">
      <!-- ì „ê´‘íŒ ê³µì§€ì‚¬í•­ -->
      <div class="notice-ticker-container">
        <div class="notice-ticker">
          íƒ€ì¸ì„ í–¥í•œ ìš•ì„¤, ë¹„ë°©ê¸€ì€ ì‚­ì œ ì¡°ì¹˜ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìƒí˜¸ ë°°ë ¤í•˜ëŠ” ë§ˆìŒìœ¼ë¡œ ê±´ì „í•œ ì»¤ë®¤ë‹ˆí‹°ë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”! ğŸ¾
        </div>
      </div>

      <div id="boardList">
        <!-- ê²Œì‹œê¸€ì´ ì—†ì„ ë•Œ í‘œì‹œí•  ë©”ì‹œì§€ -->
        <div th:if="${#lists.isEmpty(boardList)}" class="no-posts">
          <img src="/images/empty-box.svg" alt="ë¹ˆ ë°•ìŠ¤">
          <div class="message">ì•„ì§ ë“±ë¡ëœ ê²Œì‹œê¸€ì´ ì—†ì–´ìš”!</div>
          <div class="sub-message">ì²« ë²ˆì§¸ ê²Œì‹œê¸€ì˜ ì£¼ì¸ê³µì´ ë˜ì–´ë³´ì„¸ìš” ğŸ¾</div>
        </div>
        <!-- ê²Œì‹œê¸€ ëª©ë¡ -->
        <th:block th:if="${not #lists.isEmpty(boardList)}" th:each="board, iterStat : ${boardList}">
          <div class="board-item" 
               th:classappend="${board.bType == 'ê³µì§€ì‚¬í•­'} ? 'notice-post' : (${board.member != null && board.member.role != null && board.member.role.name() == 'ADMIN'} ? 'admin-post')"
               th:style="${iterStat.index >= 10 ? 'display: none;' : ''}"
               th:onclick="'location.href=\'/board/detail/' + ${board.bIdx} + '\''">
            <div class="board-content">
              <div class="board-info">
                <span class="board-category" th:text="${board.bType}">ì¹´í…Œê³ ë¦¬</span>
                <span class="board-stats">
                  <span class="views" title="ì¡°íšŒìˆ˜">ğŸ‘ï¸ <span th:text="${board.readRate}">0</span></span>
                  <span class="likes" title="ì¢‹ì•„ìš”">â¤ï¸ <span th:text="${board.likeCount}">0</span></span>
                </span>
              </div>
              <h3 class="board-title" th:text="${board.title}">ì œëª©</h3>
              <div class="board-meta">
                <span th:text="${board.member.name}">ì‘ì„±ì</span>
                <span th:text="${board.insertDate}">ì‘ì„±ì¼</span>
                <span class="has-image" th:if="${attachmentCounts.get(board.bIdx) > 0}">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                  </svg>
                  <span th:text="${attachmentCounts.get(board.bIdx)}">0</span>
                </span>
              </div>
            </div>
          </div>
        </th:block>
      </div>
      <!-- ë”ë³´ê¸° ë²„íŠ¼ -->
      <div class="load-more-container" th:if="${#lists.size(boardList) > 10}">
        <button id="loadMoreBtn" class="load-more-btn">
          ë”ë³´ê¸°
          <span class="loading"></span>
        </button>
      </div>
    </div>
    
    <!-- ê¸€ì“°ê¸° ë²„íŠ¼ -->
    <div class="write-button" 
        th:if="${session.sessionMember != null}"
        onclick="handleWriteButtonClick()"
        title="ê¸€ì“°ê¸°">
        <img src="/images/write-button.svg" alt="ê¸€ì“°ê¸°">
    </div>
    <div class="write-button" 
        th:unless="${session.sessionMember != null}"
        onclick="alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.'); location.href='/member/login';"
        title="ê¸€ì“°ê¸°">
        <img src="/images/write-button.svg" alt="ê¸€ì“°ê¸°">
    </div>
  </div>

  <!-- footer -->
  <div th:replace="~{common/footer :: footer}"></div>
  <!-- /footer -->

  <!-- Loading Modal -->
  <div id="loadingModal" class="loading-modal">
    <div class="loading-content">
      <div class="loading-dog">ğŸ•</div>
      <div class="loading-text">ê¸€ì“°ê¸° í˜ì´ì§€ë¡œ ì´ë™ì¤‘...</div>
    </div>
  </div>

  <script>
    function filterPosts(type) {
      // ëª¨ë“  ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ì˜ active í´ë˜ìŠ¤ ì œê±°
      document.querySelectorAll('.boardMenu > div').forEach(div => {
        div.classList.remove('active');
      });
      
      // í´ë¦­ëœ ë²„íŠ¼ì— active í´ë˜ìŠ¤ ì¶”ê°€
      event.currentTarget.classList.add('active');
      
      // ì¹´í…Œê³ ë¦¬ì— ë”°ë¥¸ URL ì„¤ì •
      let url = '/board';
      if (type !== 'ì „ì²´') {
        url += '?category=' + encodeURIComponent(type);
      }
      
      // í˜ì´ì§€ ì´ë™
      window.location.href = url;
    }

    function handleWriteButtonClick() {
      const writeButton = document.querySelector('.write-button');
      const loadingModal = document.getElementById('loadingModal');
      
      // ë¨¼ì € íˆ´íŒ ë³´ì—¬ì£¼ê¸°
      writeButton.classList.add('show-tooltip');
      
      // 1ì´ˆ í›„ì— íˆ´íŒ ìˆ¨ê¸°ê³  ë¡œë”© ëª¨ë‹¬ ë³´ì—¬ì£¼ê¸°
      setTimeout(() => {
        writeButton.classList.remove('show-tooltip');
        loadingModal.style.display = 'flex';
        
        // 0.5ì´ˆ í›„ì— í˜ì´ì§€ ì´ë™
        setTimeout(() => {
          location.href = '/board/create';
        }, 500);
      }, 1000);
    }

    document.addEventListener('DOMContentLoaded', function() {
      let startY = 0;
      let pullDistance = 0;
      const THRESHOLD = 80;
      const postsContainer = document.querySelector('.posts-container');
      const refreshIndicator = document.querySelector('.refresh-indicator');
      const refreshSpinner = document.querySelector('.refresh-spinner');
      const refreshText = document.querySelector('.refresh-text');
      let isRefreshing = false;

      // í˜„ì¬ ì¹´í…Œê³ ë¦¬ì— ë”°ë¼ ë²„íŠ¼ í™œì„±í™”
      const urlParams = new URLSearchParams(window.location.search);
      const category = urlParams.get('category') || 'ì „ì²´';
      
      const targetDiv = document.querySelector(`.boardMenu > div[onclick="filterPosts('${category}')"]`);
      if (targetDiv) {
        document.querySelectorAll('.boardMenu > div').forEach(div => {
          div.classList.remove('active');
        });
        targetDiv.classList.add('active');
      }

      let currentlyShown = 10;
      const postsPerPage = 10;
      
      const loadMoreBtn = document.getElementById('loadMoreBtn');
      if(loadMoreBtn) {
        loadMoreBtn.addEventListener('click', function() {
          // ë¡œë”© ìƒíƒœ ì¶”ê°€
          this.classList.add('loading-state');
          
          setTimeout(() => {
            const posts = document.querySelectorAll('.board-item');
            const totalPosts = posts.length;
            
            // ë‹¤ìŒ 10ê°œì˜ ê²Œì‹œê¸€ í‘œì‹œ
            for(let i = currentlyShown; i < currentlyShown + postsPerPage && i < totalPosts; i++) {
              posts[i].style.display = '';
            }
            
            currentlyShown += postsPerPage;
            
            // ë¡œë”© ìƒíƒœ ì œê±°
            this.classList.remove('loading-state');
            
            // ëª¨ë“  ê²Œì‹œê¸€ì„ ë‹¤ ë³´ì—¬ì¤¬ë‹¤ë©´ ë”ë³´ê¸° ë²„íŠ¼ í˜ì´ë“œì•„ì›ƒ í›„ ì œê±°
            if(currentlyShown >= totalPosts) {
              this.style.opacity = '0';
              setTimeout(() => {
                this.style.display = 'none';
              }, 300);
            }
          }, 800); // ë¡œë”© íš¨ê³¼ë¥¼ ë³´ì—¬ì£¼ê¸° ìœ„í•œ ì§€ì—°
        });
      }

      postsContainer.addEventListener('touchstart', (e) => {
        if (isRefreshing || postsContainer.scrollTop > 0) return;
        
        startY = e.touches[0].clientY;
        refreshIndicator.style.display = 'block';
        postsContainer.style.transition = '';
      });

      postsContainer.addEventListener('touchmove', (e) => {
        if (!startY || isRefreshing || postsContainer.scrollTop > 0) return;

        const currentY = e.touches[0].clientY;
        pullDistance = currentY - startY;

        if (pullDistance > 0) {
          e.preventDefault();
          postsContainer.style.transform = `translateY(${Math.min(pullDistance * 0.3, 80)}px)`;
          refreshSpinner.style.transform = `rotate(${pullDistance * 2}deg)`;
          refreshIndicator.style.opacity = Math.min(pullDistance / THRESHOLD, 1);

          // í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
          if (pullDistance >= THRESHOLD) {
            refreshText.textContent = 'ë†“ì•„ì„œ ìƒˆë¡œê³ ì¹¨';
          } else {
            refreshText.textContent = 'ë‹¹ê²¨ì„œ ìƒˆë¡œê³ ì¹¨';
          }
        }
      });

      postsContainer.addEventListener('touchend', () => {
        if (!startY || isRefreshing) {
          return;
        }

        if (pullDistance > THRESHOLD) {
          isRefreshing = true;
          refreshText.textContent = 'ìƒˆë¡œê³ ì¹¨ ì¤‘...';
          refreshSpinner.classList.add('spinning');
          refreshIndicator.style.opacity = '1';
          
          const token = document.querySelector("meta[name='_csrf']").getAttribute("content");
          const header = document.querySelector("meta[name='_csrf_header']").getAttribute("content");

          // ìƒˆë¡œê³ ì¹¨ ì¤‘ì—ëŠ” ëª©ë¡ì„ ì•½ê°„ ë‚´ë¦° ìƒíƒœë¡œ ìœ ì§€
          postsContainer.style.transition = 'transform 0.3s';
          postsContainer.style.transform = 'translateY(40px)';

          setTimeout(() => {
            // í˜„ì¬ í˜ì´ì§€ URL ì‚¬ìš©
            fetch(window.location.href, {
              method: 'GET',
              headers: {
                [header]: token,
                'X-Requested-With': 'XMLHttpRequest'
              },
              credentials: 'same-origin'
            })
            .then(response => {
              if (response.ok) {
                window.location.reload();
              }
            })
            .catch(error => {
              console.error('ìƒˆë¡œê³ ì¹¨ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
            })
            .finally(() => {
              window.location.reload();
            });
          }, 500);
        } else {
          resetRefreshState();
        }
      });

      function resetRefreshState() {
        postsContainer.style.transition = 'transform 0.3s';
        postsContainer.style.transform = 'translateY(0)';
        refreshSpinner.classList.remove('spinning');
        refreshSpinner.style.transform = 'rotate(0deg)';
        refreshText.textContent = 'ë‹¹ê²¨ì„œ ìƒˆë¡œê³ ì¹¨';
        refreshIndicator.style.opacity = '0';
        
        setTimeout(() => {
          postsContainer.style.transition = '';
          refreshIndicator.style.display = 'none';
          isRefreshing = false;
          startY = 0;
          pullDistance = 0;
        }, 300);
      }

      // ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ì²˜ë¦¬
      const topBtn = document.getElementById('top-btn');

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ë²„íŠ¼ì´ ë³´ì´ëŠ”ì§€ í™•ì¸

      postsContainer.addEventListener('scroll', function() {
        const scrollTop = this.scrollTop;
        
        if (scrollTop > 100) {
          topBtn.classList.add('visible');
        } else {
          topBtn.classList.remove('visible');
        }
      });

      // ì´ˆê¸° ìŠ¤í¬ë¡¤ ìœ„ì¹˜ í™•ì¸
      if (postsContainer.scrollTop > 100) {
        topBtn.classList.add('visible');
      }

      function scrollToTop() {
        // ë²„íŠ¼ í´ë¦­ì‹œ ë¨¼ì € ë²„íŠ¼ì„ ìœ„ë¡œ ì˜¬ë¦¬ë©´ì„œ ì‚¬ë¼ì§€ê²Œ
        topBtn.style.transform = 'translateX(-50%) translateY(-20px)';
        topBtn.style.opacity = '0';
        
        // ê·¸ ë‹¤ìŒ ìŠ¤í¬ë¡¤
        setTimeout(() => {
          postsContainer.scrollTo({
            top: 0,
            behavior: 'smooth'
          });
          
          // ìŠ¤í¬ë¡¤ì´ ëë‚˜ë©´ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
          setTimeout(() => {
            topBtn.style.transform = '';
            topBtn.style.opacity = '';
            if (postsContainer.scrollTop > 100) {
              topBtn.classList.add('visible');
            }
          }, 500); // ìŠ¤í¬ë¡¤ ì• ë‹ˆë©”ì´ì…˜ì´ ëë‚  ë•Œì¯¤
        }, 200);
      }

      // ì „ê´‘íŒ ì• ë‹ˆë©”ì´ì…˜ ì¬ì‹œì‘
      function restartTicker() {
        const ticker = document.querySelector('.notice-ticker');
        ticker.style.animation = 'none';
        ticker.offsetHeight; // Trigger reflow
        ticker.style.animation = null;
      }

      // ì „ê´‘íŒì´ ëì— ë„ë‹¬í•˜ë©´ ìë™ìœ¼ë¡œ ì¬ì‹œì‘
      document.querySelector('.notice-ticker').addEventListener('animationend', restartTicker);
    });
  </script>
</body>
</html>