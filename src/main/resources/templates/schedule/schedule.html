<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PETOPIA - Schedule</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAyQygBh-3yT1w9IwEOALZVRr3833ZaD-8&libraries=geometry"></script>
    <!-- TOAST UI Calendar CSS -->
    <link rel="stylesheet" href="https://uicdn.toast.com/calendar/latest/toastui-calendar.min.css" />
    <link rel="stylesheet" href="/css/header.css">
    <link rel="stylesheet" href="/css/footer.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: Arial, sans-serif;
            position: relative;
            margin: 0;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            height: calc(100vh - 110px);
            max-width: 430px;
            margin: 0 auto;
            background: white;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .petopia {
            font-weight: bold;
            font-size: 1.2rem;
            color: #333;
        }

        .header-icons img {
            width: 24px;
            height: 24px;
            margin-left: 1rem;
        }

        .calendar-container {
            display: flex;
            flex-direction: column;
            background: white;
            margin-top: 3rem;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            flex: 1;
        }

        .calendar-header {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 35px;
            border-bottom: 1px solid #eee;
        }

        .calendar-buttons {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .view-buttons, .nav-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .view-buttons button {
            padding: 0.5rem 1rem;
            border: 1px solid #ddd;
            border-radius: 20px;
            background: rgba(136, 184, 246, 0.15);
            color: #1a73e8;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .view-buttons button.active {
            background: rgba(136, 184, 246, 0.15);
            color: #1a73e8;
            border-color: #1a73e8;
            font-weight: bold;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            background: rgba(136, 184, 246, 0.15);
            color: #1a73e8;
            border: none;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .btn.nav-btn {
            background: white;
            color: #1a73e8;
            border: 1px solid #1a73e8;
            padding: 0.5rem 0.75rem;
        }

        .btn:hover {
            opacity: 0.9;
        }

        #addScheduleBtn {
            background: #1a73e8;
            color: white;
            padding: 0.75rem 1.5rem;
            margin-top: 0.5rem;
        }

        #calendar {
            flex: 1;
            overflow: hidden;
        }

        .nav-item {
            text-align: center;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.8rem;
            color: #666;
        }

        .nav-item img {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
        }

        .nav-item.active {
            color: #1a73e8;
        }

        /* TOAST UI Calendar 커스텀 스타일 */
        .toastui-calendar-layout {
            border-radius: 12px;
            border: none;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
        }

        .toastui-calendar-day-name {
            font-weight: 600;
            color: #333;
            padding: 8px 0;
        }

        .toastui-calendar-grid-cell {
            background: white;
            border: none !important;
        }

        .toastui-calendar-grid-cell-date {
            font-weight: 500;
            padding: 4px;
        }

        .toastui-calendar-weekday-grid-date {
            color: #333;
            font-weight: normal;
        }

        .toastui-calendar-weekday-grid-date.toastui-calendar-weekday-grid-date-sunday {
            color: #FF0000;
        }

        .toastui-calendar-weekday-grid-date.toastui-calendar-weekday-grid-date-saturday {
            color: #0000FF;
        }

        .toastui-calendar-weekday-grid-date.toastui-calendar-weekday-grid-date-today {
            color: #1a73e8;
            font-weight: bold;
        }

        .toastui-calendar-events.toastui-calendar-events-time {
            margin-top: 4px;
        }

        .toastui-calendar-event {
            border-radius: 4px;
            margin-bottom: 2px;
        }

        .toastui-calendar-more-events {
            background-color: #f1f3f4;
        }

        /* 주간 보기 스타일 */
        .toastui-calendar-week-view {
            height: 100%;
        }

        .toastui-calendar-week-view::-webkit-scrollbar {
            width: 8px;
        }

        .toastui-calendar-week-view::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .toastui-calendar-week {
            border-left: 0!important; 
        }

        /* 이벤트 목록 모달 스타일 */
        .event-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .event-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .event-item:hover {
            background-color: #f5f5f5;
        }
        
        .event-time {
            font-weight: bold;
            margin-right: 10px;
            color: #333;
        }

        /* 모달 스타일 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 12px;
            width: 80%;
            max-width: 500px;
            position: relative;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            color: #333;
        }

        .close {
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #666;
        }

        .close:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .form-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <!-- header -->
    <div th:replace="~{common/header :: header}"></div>
    <!-- /header -->

    <div class="container">
        <div class="calendar-header">
            <div class="calendar-buttons">
                <div class="view-buttons">
                    <button id="monthViewBtn" class="active">월</button>
                    <button id="weekViewBtn">주</button>
                </div>
                <div class="nav-buttons">
                    <button id="prevBtn" class="btn nav-btn">&lt;</button>
                    <span id="currentRange" style="font-weight: bold;"></span>
                    <button id="nextBtn" class="btn nav-btn">&gt;</button>
                </div>
                <button id="addScheduleBtn" class="btn">일정 추가</button>
            </div>
        </div>

        <div id="calendar"></div>
    </div>

    <!-- 일정 추가 모달 -->
    <div id="addScheduleModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addScheduleModal')">&times;</span>
            <div class="modal-header">
                <h2>일정 추가</h2>
            </div>
            <form id="scheduleForm">
                <div class="form-group">
                    <label for="title">제목</label>
                    <input type="text" id="title" name="title" required>
                </div>
                <div class="form-group">
                    <label for="content">내용</label>
                    <textarea id="content" name="content"></textarea>
                </div>
                <div class="form-group">
                    <label for="startTime">시작 시간</label>
                    <input type="datetime-local" id="startTime" name="startTime" required>
                </div>
                <div class="form-group">
                    <label for="endTime">종료 시간</label>
                    <input type="datetime-local" id="endTime" name="endTime" required>
                </div>
                <div class="form-buttons">
                    <button type="submit" class="btn btn-primary">저장</button>
                    <button type="button" class="btn" onclick="closeModal('addScheduleModal')">취소</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 이벤트 목록 모달 -->
    <div id="eventListModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('eventListModal')">&times;</span>
            <div class="modal-header">
                <h2 id="modalDate"></h2>
            </div>
            <ul id="eventList" class="event-list">
            </ul>
        </div>
    </div>

    <!-- footer -->
    <div th:replace="~{common/footer :: footer}"></div>
    <!-- /footer -->

    <!-- TOAST UI Calendar JS -->
    <script src="https://uicdn.toast.com/calendar/latest/toastui-calendar.min.js"></script>
    <script>
        const Calendar = tui.Calendar;
        let map;
        let currentPath;
        
        // 캘린더 초기화
        const calendar = new Calendar('#calendar', {
            defaultView: 'month',
            isReadOnly: true,
            month: {
                dayNames: ['일', '월', '화', '수', '목', '금', '토'],
                visibleEventCount: 0,
            },
            template: {
                monthDayname: function(model) {
                    return model.label;
                },
                monthGridHeader: function(model) {
                    const date = parseInt(model.date.split('-')[2], 10);
                    const day = model.day;
                    const isToday = model.isToday;
                    const events = model.events || [];
                    const style = day === 0 ? 'color: #FF0000;' : 
                                day === 6 ? 'color: #0000FF;' : '';
                    
                    let html = `<span class="${isToday ? 'today' : ''}" style="${style}">${date}</span>`;
                    
                    if (events.length > 0) {
                        // 숫자에 클릭 이벤트 추가
                        html = `<span onclick="showEventList('${model.date}', ${events.length})">${html}</span>`;
                    }
                    
                    return html;
                }
            }
        });

        // 일정과 산책 데이터 한 번에 가져오기
        fetch('/schedule/events')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // 기존 이벤트 모두 제거
                calendar.clear();
                
                // 새 이벤트 추가
                const events = data.events || [];
                calendar.createEvents(events);
                
                // 초기 날짜 범위 업데이트
                updateViewRange();
            })
            .catch(error => {
                console.error('Error fetching events:', error);
            });

        // 이벤트 목록 표시 함수 수정
        function showEventList(dateStr, count) {
            const date = new Date(dateStr);
            const events = calendar.getEvents(date);
            const modalDate = document.getElementById('modalDate');
            const eventList = document.getElementById('eventList');
            const modal = document.getElementById('eventListModal');

            modalDate.textContent = `${date.getFullYear()}년 ${date.getMonth() + 1}월 ${date.getDate()}일`;
            eventList.innerHTML = '';

            events.forEach(event => {
                const li = document.createElement('li');
                const time = new Date(event.start);
                li.innerHTML = `
                    <div class="event-item">
                        <span class="event-time">${String(time.getHours()).padStart(2, '0')}:${String(time.getMinutes()).padStart(2, '0')}</span>
                        <span class="event-title">${event.title}</span>
                    </div>
                `;
                // 직접 클릭 이벤트 핸들러를 추가
                li.querySelector('.event-item').addEventListener('click', () => {
                    showDetailView(event);
                });
                eventList.appendChild(li);
            });

            modal.style.display = 'block';
        }

        function showDetailView(event) {
            const modal = document.getElementById('editModal');
            const eventId = document.getElementById('editEventId');
            const title = document.getElementById('editTitle');
            const content = document.getElementById('editContent');
            const start = document.getElementById('editStart');
            const end = document.getElementById('editEnd');
            
            // 이벤트 ID 설정
            eventId.value = event.id;
            
            // 제목과 내용 설정
            title.value = event.title;
            content.value = event.content || '';
            
            // 시작 시간과 종료 시간 설정
            start.value = formatDateTimeLocal(new Date(event.start));
            end.value = formatDateTimeLocal(new Date(event.end));
            
            // 수정 모드로 전환
            modal.style.display = 'block';
            
            // 이벤트 목록 모달 닫기
            document.getElementById('eventListModal').style.display = 'none';
        }

        function toggleEditMode() {
            const editForm = document.getElementById('editForm');
            const viewMode = document.getElementById('viewMode');
            editForm.style.display = 'block';
            viewMode.style.display = 'none';
        }

        function cancelEdit() {
            const editForm = document.getElementById('editForm');
            const viewMode = document.getElementById('viewMode');
            editForm.style.display = 'none';
            viewMode.style.display = 'block';
        }

        function updateSchedule() {
            const eventId = document.getElementById('editEventId').value;
            const title = document.getElementById('editTitle').value;
            const content = document.getElementById('editContent').value;
            const start = document.getElementById('editStart').value;
            const end = document.getElementById('editEnd').value;
            
            // 수정할 데이터 준비
            const scheduleData = {
                saIdx: eventId.replace('s', ''),
                title: title,
                content: content,
                startTime: start,
                endTime: end
            };
            
            // 서버로 수정 요청 보내기
            fetch('/schedule/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(scheduleData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // 수정 성공 시 모달을 닫고 캘린더 새로고침
                    closeModal('editModal');
                    fetchEvents();
                } else {
                    alert('일정 수정에 실패했습니다.');
                }
            })
            .catch(error => {
                console.error('Error updating schedule:', error);
                alert('일정 수정 중 오류가 발생했습니다.');
            });
        }

        function fetchEvents() {
            fetch('/schedule/events')
                .then(response => response.json())
                .then(data => {
                    calendar.clear();
                    calendar.createEvents(data.events || []);
                })
                .catch(error => {
                    console.error('Error fetching events:', error);
                });
        }

        // datetime-local 입력을 위한 날짜 포맷 함수
        function formatDateTimeLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        function formatDate(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        // 모달 닫기 함수
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                
                // 폼이 있다면 리셋
                const form = modal.querySelector('form');
                if (form) {
                    form.reset();
                }
            }
        }

        // 모달 외부 클릭 시 닫기
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
                
                // 폼이 있다면 리셋
                const form = event.target.querySelector('form');
                if (form) {
                    form.reset();
                }
            }
        };

        document.addEventListener('DOMContentLoaded', function() {
            // 뷰 변경 버튼 이벤트 핸들러
            document.getElementById('monthViewBtn').addEventListener('click', function() {
                calendar.changeView('month');
                this.classList.add('active');
                document.getElementById('weekViewBtn').classList.remove('active');
                updateViewRange();
            });
            
            document.getElementById('weekViewBtn').addEventListener('click', function() {
                calendar.changeView('week');
                this.classList.add('active');
                document.getElementById('monthViewBtn').classList.remove('active');
                updateViewRange();
            });
            
            // 이전/다음 버튼 이벤트 핸들러
            document.getElementById('prevBtn').addEventListener('click', function() {
                calendar.prev();
                updateViewRange();
            });
            
            document.getElementById('nextBtn').addEventListener('click', function() {
                calendar.next();
                updateViewRange();
            });
            
            // 일정 추가 버튼 클릭 이벤트
            document.getElementById('addScheduleBtn').addEventListener('click', function() {
                const now = new Date();
                const localDateTime = formatDateTimeLocal(now);
                
                document.getElementById('startTime').value = localDateTime;
                document.getElementById('endTime').value = localDateTime;
                
                const modal = document.getElementById('addScheduleModal');
                modal.style.display = 'block';
            });
            
            // 모달 닫기 버튼 이벤트
            document.querySelectorAll('.close, .close-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    modal.style.display = 'none';
                    
                    // 폼이 있다면 리셋
                    const form = modal.querySelector('form');
                    if (form) {
                        form.reset();
                    }
                });
            });
            
            // 초기 날짜 범위 표시
            updateViewRange();
        });

        // 현재 뷰의 날짜 범위 업데이트 함수
        function updateViewRange() {
            const viewName = calendar.getViewName();
            const viewDate = calendar.getDate();
            const currentRange = document.getElementById('currentRange');
            
            if (viewName === 'month') {
                currentRange.textContent = `${viewDate.getFullYear()}년 ${viewDate.getMonth() + 1}월`;
            } else if (viewName === 'week') {
                const weekStart = calendar.getDateRangeStart();
                const weekEnd = calendar.getDateRangeEnd();
                currentRange.textContent = `${weekStart.getFullYear()}년 ${weekStart.getMonth() + 1}월 ${weekStart.getDate()}일 - ${weekEnd.getMonth() + 1}월 ${weekEnd.getDate()}일`;
            }
        }

        function initWalkMap(walkId) {
            // 지도 초기화
            map = new google.maps.Map(document.getElementById('walkMap'), {
                zoom: 16,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                disableDefaultUI: true
            });
            
            // 산책 경로 데이터 가져오기
            fetch(`/walk/path/${walkId}`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.coordinates && data.coordinates.length > 0) {
                        const coordinates = data.coordinates;
                        const path = coordinates.map(coord => ({
                            lat: coord.latitude,
                            lng: coord.longitude
                        }));
                        
                        // 경로 그리기
                        currentPath = new google.maps.Polyline({
                            path: path,
                            geodesic: true,
                            strokeColor: '#FF0000',
                            strokeOpacity: 1.0,
                            strokeWeight: 2,
                            map: map
                        });
                        
                        // 경로의 bounds 계산
                        const bounds = new google.maps.LatLngBounds();
                        path.forEach(point => bounds.extend(point));
                        
                        // 지도를 경로가 모두 보이도록 조정
                        map.fitBounds(bounds);
                        
                        // 시작점과 끝점 마커 추가
                        if (path.length > 0) {
                            // 시작점 마커
                            new google.maps.Marker({
                                position: path[0],
                                map: map,
                                icon: {
                                    path: google.maps.SymbolPath.CIRCLE,
                                    scale: 8,
                                    fillColor: '#4CAF50',
                                    fillOpacity: 1,
                                    strokeWeight: 2,
                                    strokeColor: '#FFFFFF'
                                },
                                title: '시작점'
                            });
                            
                            // 끝점 마커
                            new google.maps.Marker({
                                position: path[path.length - 1],
                                map: map,
                                icon: {
                                    path: google.maps.SymbolPath.CIRCLE,
                                    scale: 8,
                                    fillColor: '#F44336',
                                    fillOpacity: 1,
                                    strokeWeight: 2,
                                    strokeColor: '#FFFFFF'
                                },
                                title: '끝점'
                            });
                        }
                    } else {
                        console.error('No path data available');
                    }
                })
                .catch(error => {
                    console.error('Error fetching walk path:', error);
                });
        }
    </script>
</body>
</html>
