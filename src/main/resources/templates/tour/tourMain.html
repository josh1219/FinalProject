<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>반려동물 동반 가능 문화시설</title>
    <style>
        #map {
            height: 600px;
            width: 100%;
            position: relative;
        }
        .info-window {
            padding: 10px;
        }
        .info-window h3 {
            margin: 0 0 10px 0;
        }
        .category-list {
            position: absolute;
            top: 10px;
            left: 420px;
            z-index: 1;
            background-color: transparent;
            padding: 10px;
            border-radius: 30px;
            display: flex;
            overflow-x: auto;
            overflow-y: hidden;
            max-width: calc(100% - 440px);
            white-space: nowrap;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
            -webkit-overflow-scrolling: touch;
        }

        /* Chrome, Safari용 스크롤바 숨기기 */
        .category-list::-webkit-scrollbar {
            display: none;
        }

        .category-button {
            margin: 0 5px;
            padding: 8px 16px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .category-button img {
            width: 20px;
            height: 20px;
        }

        .category-button.active {
            background-color: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        .category-button:hover {
            background-color: rgba(255, 255, 255, 1);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .category-button:first-child {
            margin-left: 0;
        }

        .category-button:last-child {
            margin-right: 0;
        }

        .map-container {
            display: flex;
            width: 100%;
            height: 800px;
            position: relative;
        }

        #map {
            flex: 1;
            height: 100%;
            position: relative;
        }

        .side-panel-container {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            z-index: 2;
            display: flex;
            transition: transform 0.3s ease;
        }

        .side-panel-container.collapsed {
            transform: translateX(-400px);
        }

        .places-panel {
            width: 400px;
            height: 100%;
            background: white;
            overflow-y: auto;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }

        .toggle-panel-btn {
            width: 25px;
            height: 50px;
            background: white;
            border: none;
            border-radius: 0 4px 4px 0;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 300px;
            color: #666;
            font-size: 12px;
        }

        .toggle-panel-btn::after {
            content: '◀';
            transition: transform 0.3s ease;
        }

        .side-panel-container.collapsed .toggle-panel-btn::after {
            transform: rotate(180deg);
        }

        .search-box {
            padding: 15px;
            background: #fff;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .search-button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .search-button:hover {
            background-color: #45a049;
        }

        .place-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .place-item:hover {
            background-color: #f8f8f8;
        }

        .place-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .place-address {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .place-category {
            color: #009688;
            font-size: 0.8em;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
            border-top: 1px solid #eee;
        }

        .pagination button {
            margin: 0 5px;
            padding: 5px 10px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 3px;
        }

        .pagination button:hover {
            background: #f5f5f5;
        }

        .pagination button.active {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        .pagination button:disabled {
            background: #f5f5f5;
            cursor: not-allowed;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="map-container">
        <div class="side-panel-container collapsed">
            <div class="places-panel">
                <div class="search-box">
                    <input type="text" class="search-input" placeholder="장소 검색..." id="searchInput">
                    <button class="search-button" onclick="handleSearch()">검색</button>
                </div>
                <div id="places-list">
                    <!-- 장소 목록이 여기에 동적으로 추가됨 -->
                </div>
                <div class="pagination">
                    <button onclick="changePage('prev')" id="prevPage">이전</button>
                    <span id="currentPage">1</span> / <span id="totalPages">1</span>
                    <button onclick="changePage('next')" id="nextPage">다음</button>
                </div>
            </div>
            <button class="toggle-panel-btn" onclick="togglePanel()"></button>
        </div>
        <div id="map"></div>
        <div class="category-list">
            <button class="category-button" data-category="동물병원" onclick="toggleCategory(this)">
                <img src="/images/markers/hospital.png" alt="동물병원">
                동물병원
            </button>
            <button class="category-button" data-category="동물약국" onclick="toggleCategory(this)">
                <img src="/images/markers/pharmacy.png" alt="동물약국">
                동물약국
            </button>
            <button class="category-button" data-category="식당" onclick="toggleCategory(this)">
                <img src="/images/markers/restaurant.png" alt="식당">
                식당
            </button>
            <button class="category-button" data-category="여행지" onclick="toggleCategory(this)">
                <img src="/images/markers/travel.png" alt="여행지">
                여행지
            </button>
            <button class="category-button" data-category="미용" onclick="toggleCategory(this)">
                <img src="/images/markers/beauty.png" alt="미용">
                미용
            </button>
            <button class="category-button" data-category="박물관" onclick="toggleCategory(this)">
                <img src="/images/markers/museum.png" alt="박물관">
                박물관
            </button>
            <button class="category-button" data-category="반려동물용품" onclick="toggleCategory(this)">
                <img src="/images/markers/pet-shop.png" alt="반려동물용품">
                반려동물용품
            </button>
            <button class="category-button" data-category="문예회관" onclick="toggleCategory(this)">
                <img src="/images/markers/culture.png" alt="문예회관">
                문예회관
            </button>
            <button class="category-button" data-category="미술관" onclick="toggleCategory(this)">
                <img src="/images/markers/art.png" alt="미술관">
                미술관
            </button>
            <button class="category-button" data-category="위탁관리" onclick="toggleCategory(this)">
                <img src="/images/markers/pet-hotel.png" alt="위탁관리">
                위탁관리
            </button>
            <button class="category-button" data-category="카페" onclick="toggleCategory(this)">
                <img src="/images/markers/cafe.png" alt="카페">
                카페
            </button>
            <button class="category-button" data-category="펜션" onclick="toggleCategory(this)">
                <img src="/images/markers/pension.png" alt="펜션">
                펜션
            </button>
            <button class="category-button" data-category="호텔" onclick="toggleCategory(this)">
                <img src="/images/markers/hotel.png" alt="호텔">
                호텔
            </button>
        </div>
    </div>

    <script th:inline="javascript">
        let map;
        let markers = [];
        let tourData = [];  // 전체 데이터 저장
        let filteredPlaces = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        const markerIcons = {
            '동물병원': '/images/markers/hospital.png',
            '동물약국': '/images/markers/pharmacy.png',
            '식당': '/images/markers/restaurant.png',
            '여행지': '/images/markers/travel.png',
            '미용': '/images/markers/beauty.png',
            '박물관': '/images/markers/museum.png',
            '반려동물용품': '/images/markers/pet-shop.png',
            '문예회관': '/images/markers/culture.png',
            '미술관': '/images/markers/art.png',
            '위탁관리': '/images/markers/pet-hotel.png',
            '카페': '/images/markers/cafe.png',
            '펜션': '/images/markers/pension.png',
            '호텔': '/images/markers/hotel.png'
        };

        function getMarkerIcon(category) {
            return {
                url: markerIcons[category],
                scaledSize: new google.maps.Size(20, 20), // 아이콘 크기 조절
                origin: new google.maps.Point(0, 0),
                anchor: new google.maps.Point(15, 15)
            };
        }

        async function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 37.5665, lng: 126.9780 },
                zoom: 12,
                mapTypeControl: false,
                fullscreenControl: false,
                styles: [
                    {
                        featureType: "poi",
                        elementType: "labels",
                        stylers: [
                            { visibility: "off" }
                        ]
                    }
                ]
            });

            // 현재 위치 버튼 추가
            const locationButton = document.createElement("button");
            locationButton.classList.add("custom-map-control");
            locationButton.innerHTML = `
                <img src="/images/markers/location.png" alt="현재 위치" style="width: 35px; height: 35px;">
            `;
            locationButton.style.cssText = `
                background-color: rgba(0, 0, 0, 0.1);
                border: none;
                border-radius: 2px;
                box-shadow: 2px 0 5px rgba(0,0,0,0.3);
                margin: 10px;
                padding: 8px;
                cursor: pointer;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(locationButton);

            // 현재 위치 마커
            let currentLocationMarker = null;

            // 현재 위치 버튼 클릭 이벤트
            locationButton.addEventListener("click", () => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const pos = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };

                            // 기존 마커가 있다면 제거
                            if (currentLocationMarker) {
                                currentLocationMarker.setMap(null);
                            }

                            // 현재 위치 마커 생성
                            currentLocationMarker = new google.maps.Marker({
                                position: pos,
                                map: map,
                                icon: {
                                    path: google.maps.SymbolPath.CIRCLE,
                                    scale: 10,
                                    fillColor: "#4285F4",
                                    fillOpacity: 1,
                                    strokeColor: "#ffffff",
                                    strokeWeight: 2,
                                }
                            });

                            // 지도 중심을 현재 위치로 이동
                            map.setCenter(pos);
                            map.setZoom(15);
                        },
                        (error) => {
                            console.error("Error getting current location:", error);
                            alert("현재 위치를 가져올 수 없습니다.");
                        }
                    );
                } else {
                    alert("이 브라우저에서는 위치 정보를 지원하지 않습니다.");
                }
            });

            // 데이터 로드
            try {
                console.log('Fetching tour data...');
                const response = await fetch('/tour/data');
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const text = await response.text();
                console.log('Response text:', text.substring(0, 200) + '...'); // 처음 200자만 로그
                tourData = JSON.parse(text);
                console.log('Parsed tour data:', tourData.length, 'items');
                showMarkers();
            } catch (error) {
                console.error('Error loading tour data:', error);
            }
        }

        function getCategoryMapping(category1, category2, category3) {
            // 디버깅을 위한 로그 추가
            console.log('Mapping categories:', { category1, category2, category3 });
            
            // 카테고리 매핑
            if (category1 === "동물병원" || category2 === "동물병원" || category3 === "동물병원") return "동물병원";
            if (category1 === "동물약국" || category2 === "동물약국" || category3 === "동물약국") return "동물약국";
            if (category1 === "식당" || category2 === "식당" || category3 === "식당") return "식당";
            if (category1 === "여행지" || category2 === "여행지" || category3 === "여행지") return "여행지";
            if (category1 === "미용" || category2 === "미용" || category3 === "미용") return "미용";
            if (category1 === "박물관" || category2 === "박물관" || category3 === "박물관") return "박물관";
            if (category1 === "반려동물용품" || category2 === "반려동물용품" || category3 === "반려동물용품") return "반려동물용품";
            if (category1 === "문예회관" || category2 === "문예회관" || category3 === "문예회관") return "문예회관";
            if (category1 === "미술관" || category2 === "미술관" || category3 === "미술관") return "미술관";
            if (category1 === "위탁관리" || category2 === "위탁관리" || category3 === "위탁관리") return "위탁관리";
            if (category1 === "카페" || category2 === "카페" || category3 === "카페") return "카페";
            if (category1 === "펜션" || category2 === "펜션" || category3 === "펜션") return "펜션";
            if (category1 === "호텔" || category2 === "호텔" || category3 === "호텔") return "호텔";
            return null;
        }

        // 페이지 로드 시 초기 설정
        window.onload = function() {
            const container = document.querySelector('.side-panel-container');
            const categoryList = document.querySelector('.category-list');
            
            // 초기 상태가 collapsed이므로 카테고리 리스트도 이동
            if (container.classList.contains('collapsed')) {
                categoryList.style.left = '50px';
            }
        }

        function showMarkers() {
            // 기존 마커 제거
            markers.forEach(marker => marker.setMap(null));
            markers = [];

            // 활성화된 카테고리 확인
            const activeCategories = Array.from(document.querySelectorAll('.category-button.active'))
                .map(button => button.getAttribute('data-category'))
                .filter(category => category !== '모두');

            // 장소 목록 초기화
            filteredPlaces = [];

            // 마커 생성 및 장소 목록 데이터 준비
            tourData.forEach(place => {
                const category = getCategoryMapping(place.카테고리1, place.카테고리2, place.카테고리3);
                if (category && activeCategories.includes(category)) {
                    const latitude = parseFloat(place.위도);
                    const longitude = parseFloat(place.경도);
                    
                    if (latitude && longitude && !isNaN(latitude) && !isNaN(longitude)) {
                        const marker = new google.maps.Marker({
                            position: { lat: latitude, lng: longitude },
                            map: map,
                            title: place.시설명,
                            icon: getMarkerIcon(category)
                        });

                        // 장소 정보를 filteredPlaces 배열에 추가
                        filteredPlaces.push({
                            name: place.시설명,
                            address: `${place.법정읍면동명칭 || ''} ${place.도로명주소 || ''}`,
                            category: category,
                            marker: marker,
                            position: { lat: latitude, lng: longitude },
                            phone: place.전화번호
                        });

                        markers.push(marker);
                    }
                }
            });

            // 페이지네이션 업데이트 및 첫 페이지 표시
            currentPage = 1;
            updatePagination();
            displayCurrentPage();
        }

        function displayCurrentPage() {
            const placesList = document.getElementById('places-list');
            placesList.innerHTML = '';

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredPlaces.length);

            for (let i = startIndex; i < endIndex; i++) {
                const place = filteredPlaces[i];
                const placeItem = document.createElement('div');
                placeItem.className = 'place-item';
                placeItem.innerHTML = `
                    <div class="place-name">${place.name}</div>
                    <div class="place-address">${place.address}</div>
                    <div class="place-category">${place.category}</div>
                `;

                placeItem.addEventListener('click', () => {
                    map.setCenter(place.position);
                    map.setZoom(17);

                    const infoContent = `
                        <div class="info-window">
                            <h3>${place.name}</h3>
                            <p>주소: ${place.address}</p>
                            <p>카테고리: ${place.category}</p>
                            ${place.phone ? `<p>전화: ${place.phone}</p>` : ''}
                        </div>
                    `;

                    const infoWindow = new google.maps.InfoWindow({
                        content: infoContent
                    });

                    if (currentInfoWindow) {
                        currentInfoWindow.close();
                    }
                    infoWindow.open(map, place.marker);
                    currentInfoWindow = infoWindow;
                });

                placesList.appendChild(placeItem);
            }
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredPlaces.length / itemsPerPage);
            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('totalPages').textContent = totalPages;
            
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage === totalPages;
        }

        function changePage(direction) {
            if (direction === 'prev' && currentPage > 1) {
                currentPage--;
            } else if (direction === 'next' && currentPage < Math.ceil(filteredPlaces.length / itemsPerPage)) {
                currentPage++;
            }
            updatePagination();
            displayCurrentPage();
        }

        function searchPlaces(keyword) {
            keyword = keyword.toLowerCase();
            
            // 현재 활성화된 카테고리 가져오기
            const activeCategories = Array.from(document.querySelectorAll('.category-button.active'))
                .map(button => button.getAttribute('data-category'));

            // 기존 마커 제거
            markers.forEach(marker => marker.setMap(null));
            markers = [];
            
            // 전체 데이터에서 검색
            filteredPlaces = [];
            tourData.forEach(place => {
                const category = getCategoryMapping(place.카테고리1, place.카테고리2, place.카테고리3);
                
                // 검색어와 카테고리 조건 확인
                const matchesSearch = 
                    place.시설명.toLowerCase().includes(keyword) ||
                    (place.법정읍면동명칭 && place.법정읍면동명칭.toLowerCase().includes(keyword)) ||
                    (place.도로명주소 && place.도로명주소.toLowerCase().includes(keyword)) ||
                    (category && category.toLowerCase().includes(keyword));
                
                const matchesCategory = activeCategories.length === 0 || (category && activeCategories.includes(category));

                if (matchesSearch && matchesCategory) {
                    const latitude = parseFloat(place.위도);
                    const longitude = parseFloat(place.경도);
                    
                    if (latitude && longitude && !isNaN(latitude) && !isNaN(longitude)) {
                        const marker = new google.maps.Marker({
                            position: { lat: latitude, lng: longitude },
                            map: map,
                            title: place.시설명,
                            icon: getMarkerIcon(category)
                        });

                        filteredPlaces.push({
                            name: place.시설명,
                            address: `${place.법정읍면동명칭 || ''} ${place.도로명주소 || ''}`,
                            category: category,
                            marker: marker,
                            position: { lat: latitude, lng: longitude },
                            phone: place.전화번호
                        });

                        markers.push(marker);
                    }
                }
            });

            // 페이지네이션 초기화 및 표시
            currentPage = 1;
            updatePagination();
            displayCurrentPage();
        }

        function handleSearch() {
            const searchInput = document.getElementById('searchInput');
            searchPlaces(searchInput.value);
        }

        // Enter 키 이벤트 처리
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                handleSearch();
            }
        });

        let currentInfoWindow = null;

        function toggleCategory(button) {
            button.classList.toggle('active');
            showMarkers();
        }

        function togglePanel() {
            const container = document.querySelector('.side-panel-container');
            const categoryList = document.querySelector('.category-list');
            
            container.classList.toggle('collapsed');
            
            if (container.classList.contains('collapsed')) {
                categoryList.style.left = '50px';
            } else {
                categoryList.style.left = '420px';
            }
        }
    </script>
    <script th:src="@{'https://maps.googleapis.com/maps/api/js?key=' + ${@environment.getProperty('google.maps.key')} + '&callback=initMap'}" 
            async defer></script>
</body>
</html>
